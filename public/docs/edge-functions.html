<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVLP Edge Functions Development Guide</title>
    <meta name="description" content="Complete guide to developing and using NVLP's Edge Functions for complex business logic">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/logo/IconOnly_Transparent_NoBuffer.png">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --text-dark: #2d3748;
            --text-light: #4a5568;
            --text-muted: #718096;
            --bg-light: #f7fafc;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: var(--bg-light);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header img {
            height: 40px;
            width: auto;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .nav-links {
            margin-top: 1.5rem;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            margin-right: 1.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }
        
        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        /* Content */
        .content {
            background: var(--bg-white);
            margin: 2rem 0;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .content-inner {
            padding: 3rem 2rem;
        }
        
        /* Typography */
        h1, h2, h3, h4 {
            color: var(--text-dark);
            margin-bottom: 1rem;
        }
        
        h1 {
            font-size: 2.5rem;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        
        h2 {
            font-size: 2rem;
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
        }
        
        h3 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: var(--text-light);
        }
        
        h4 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-light);
        }
        
        p {
            margin-bottom: 1rem;
            color: var(--text-light);
        }
        
        a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        /* Lists */
        ul, ol {
            margin-bottom: 1rem;
            margin-left: 2rem;
        }
        
        li {
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }
        
        /* Code blocks */
        pre {
            background: #2d3748;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            overflow-x: auto;
            font-size: 0.9rem;
        }
        
        code {
            font-family: 'Monaco', 'SF Mono', 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }
        
        p code, li code {
            background: var(--bg-light);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
        }
        
        /* Alerts */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: #ebf8ff;
            border-color: #3182ce;
            color: #2c5aa0;
        }
        
        .alert-warning {
            background: #fffbeb;
            border-color: var(--warning-color);
            color: #c05621;
        }
        
        .alert-success {
            background: #f0fff4;
            border-color: var(--success-color);
            color: #276749;
        }
        
        .alert-error {
            background: #fed7d7;
            border-color: var(--error-color);
            color: #c53030;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: var(--bg-white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-dark);
        }
        
        /* Navigation within content */
        .toc {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .toc h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }
        
        .toc ul {
            margin-left: 1rem;
        }
        
        .toc a {
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .content-inner {
                padding: 2rem 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            pre {
                padding: 1rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>
                <img src="/assets/logo/IconOnly_Transparent_NoBuffer.png" alt="NVLP Logo">
                Edge Functions Development Guide
            </h1>
            <p>Complete guide to developing and using NVLP's Edge Functions for complex business logic</p>
            <div class="nav-links">
                <a href="/docs/api">‚Üê Back to API Docs</a>
                <a href="/docs/postgrest-integration">PostgREST Integration</a>
                <a href="/docs/auth-guide">Auth Guide</a>
                <a href="https://github.com/nvlp-app" target="_blank">GitHub</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="content">
            <div class="content-inner">
                <div class="toc">
                    <h3>üìñ Table of Contents</h3>
                    <ul>
                        <li><a href="#overview">Overview</a></li>
                        <li><a href="#when-to-use">When to Use Edge Functions</a></li>
                        <li><a href="#architecture">Architecture & Patterns</a></li>
                        <li><a href="#development-setup">Development Setup</a></li>
                        <li><a href="#function-structure">Function Structure</a></li>
                        <li><a href="#authentication">Authentication & Authorization</a></li>
                        <li><a href="#validation">Validation & Error Handling</a></li>
                        <li><a href="#database-operations">Database Operations</a></li>
                        <li><a href="#testing">Testing</a></li>
                        <li><a href="#deployment">Deployment</a></li>
                        <li><a href="#monitoring">Monitoring & Debugging</a></li>
                        <li><a href="#best-practices">Best Practices</a></li>
                    </ul>
                </div>

                <section id="overview">
                    <h2>üéØ Overview</h2>
                    <p>NVLP uses Supabase Edge Functions for complex business logic that requires server-side processing, validation, and multi-table operations. Edge Functions run on Deno and provide a secure environment for operations that go beyond simple CRUD.</p>
                    
                    <div class="alert alert-info">
                        <strong>Edge Functions vs PostgREST:</strong> Use Edge Functions for complex operations with business logic, validation, and multi-step processes. Use PostgREST for simple CRUD operations and direct database queries.
                    </div>
                </section>

                <section id="when-to-use">
                    <h2>ü§î When to Use Edge Functions</h2>
                    
                    <h3>‚úÖ Perfect for Edge Functions:</h3>
                    <ul>
                        <li><strong>Complex Transaction Creation:</strong> Transactions with validation, balance checking, and constraint enforcement</li>
                        <li><strong>Business Logic:</strong> Multi-step operations that require server-side processing</li>
                        <li><strong>Data Aggregation:</strong> Complex calculations like dashboard summaries</li>
                        <li><strong>Bulk Operations:</strong> Processing multiple records with validation</li>
                        <li><strong>External Integrations:</strong> API calls to third-party services</li>
                        <li><strong>Authentication Flows:</strong> Magic link handling, user management</li>
                        <li><strong>Notifications:</strong> Email sending, webhook processing</li>
                    </ul>

                    <h3>‚ùå Better with PostgREST:</h3>
                    <ul>
                        <li>Simple CRUD operations (Create, Read, Update, Delete)</li>
                        <li>Direct data filtering and querying</li>
                        <li>Straightforward data retrieval with relationships</li>
                        <li>Basic data validation that can be handled by database constraints</li>
                    </ul>
                </section>

                <section id="architecture">
                    <h2>üèó Architecture & Patterns</h2>
                    
                    <h3>Function Structure</h3>
                    <p>All NVLP Edge Functions follow a consistent architectural pattern:</p>
                    
                    <pre><code class="language-typescript">import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { corsHeaders } from '../_shared/cors.ts'

serve(async (req) => {
  // 1. Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // 2. Authenticate user
    const authHeader = req.headers.get('Authorization')
    // ... authentication logic
    
    // 3. Parse URL and route
    const url = new URL(req.url)
    const pathParts = url.pathname.split('/').filter(p => p)
    
    // 4. Handle specific routes
    if (req.method === 'POST' && pathParts[0] === 'budgets') {
      // Handle budget creation
    }
    
    // 5. Return 404 for unmatched routes
    return new Response(JSON.stringify({ error: 'Not Found' }), {
      status: 404,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    })
    
  } catch (error) {
    // 6. Global error handling
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    })
  }
})</code></pre>

                    <h3>Shared Utilities</h3>
                    <p>Common functionality is shared across functions:</p>
                    
                    <pre><code class="language-typescript">// _shared/cors.ts
export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}</code></pre>
                </section>

                <section id="development-setup">
                    <h2>üõ† Development Setup</h2>
                    
                    <h3>Prerequisites</h3>
                    <ul>
                        <li><strong>Supabase CLI:</strong> <code>npm install -g supabase</code></li>
                        <li><strong>Deno:</strong> <code>curl -fsSL https://deno.land/install.sh | sh</code></li>
                        <li><strong>Docker:</strong> Required for local development</li>
                    </ul>

                    <h3>Local Development</h3>
                    <pre><code class="language-bash"># Start Supabase local development
supabase start

# Serve a specific function
supabase functions serve transactions

# Serve all functions
supabase functions serve

# View logs
supabase functions logs transactions</code></pre>

                    <h3>Environment Variables</h3>
                    <p>Functions access environment variables through <code>Deno.env.get()</code>:</p>
                    
                    <pre><code class="language-typescript">const supabaseUrl = Deno.env.get('SUPABASE_URL') ?? ''
const supabaseAnonKey = Deno.env.get('SUPABASE_ANON_KEY') ?? ''</code></pre>

                    <h3>Creating a New Function</h3>
                    <pre><code class="language-bash"># Create function directory and files
supabase functions new my-function

# This creates:
# supabase/functions/my-function/index.ts</code></pre>
                </section>

                <section id="function-structure">
                    <h2>üìÅ Function Structure</h2>
                    
                    <h3>Basic Function Template</h3>
                    <pre><code class="language-typescript">import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { corsHeaders } from '../_shared/cors.ts'

serve(async (req) => {
  // Handle CORS
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Your function logic here
    return new Response(
      JSON.stringify({ message: 'Hello from Edge Function!' }),
      { 
        status: 200,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { 
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    )
  }
})</code></pre>

                    <h3>URL Routing Pattern</h3>
                    <pre><code class="language-typescript">const url = new URL(req.url)
const pathParts = url.pathname.split('/').filter(p => p)

// Handle different routes
if (req.method === 'GET' && pathParts.length === 3 && 
    pathParts[0] === 'budgets' && pathParts[2] === 'transactions') {
  const budgetId = pathParts[1]
  // Handle GET /budgets/{budgetId}/transactions
}

if (req.method === 'POST' && pathParts.length === 2 && 
    pathParts[0] === 'transactions') {
  const transactionId = pathParts[1]
  // Handle POST /transactions/{transactionId}
}</code></pre>

                    <h3>Query Parameter Handling</h3>
                    <pre><code class="language-typescript">const params = url.searchParams

// Get query parameters
const limit = params.get('limit') ? parseInt(params.get('limit')!) : 50
const startDate = params.get('startDate')
const isCleared = params.get('isCleared') === 'true'

// Apply filters conditionally
let query = supabaseClient.from('transactions').select('*')

if (startDate) {
  query = query.gte('transaction_date', startDate)
}
if (params.get('isCleared') !== null) {
  query = query.eq('is_cleared', isCleared)
}</code></pre>
                </section>

                <section id="authentication">
                    <h2>üîê Authentication & Authorization</h2>
                    
                    <h3>Standard Authentication Pattern</h3>
                    <pre><code class="language-typescript">// Extract and validate authorization header
const authHeader = req.headers.get('Authorization')
if (!authHeader || !authHeader.startsWith('Bearer ')) {
  return new Response(
    JSON.stringify({ error: 'Missing or invalid authorization header' }),
    { 
      status: 401,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    }
  )
}

const token = authHeader.replace('Bearer ', '')

// Create authenticated Supabase client
const supabaseClient = createClient(
  Deno.env.get('SUPABASE_URL') ?? '',
  Deno.env.get('SUPABASE_ANON_KEY') ?? '',
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    },
    global: {
      headers: {
        Authorization: `Bearer ${token}`
      }
    }
  }
)

// Verify token and get user
const { data: { user }, error: userError } = await supabaseClient.auth.getUser()

if (userError || !user) {
  return new Response(
    JSON.stringify({ error: 'Invalid or expired token' }),
    { 
      status: 401,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    }
  )
}</code></pre>

                    <h3>Budget Access Verification</h3>
                    <pre><code class="language-typescript">// Verify user has access to the budget
const { error: budgetError } = await supabaseClient
  .from('budgets')
  .select('id')
  .eq('id', budgetId)
  .eq('user_id', user.id)
  .single()

if (budgetError) {
  if (budgetError.code === 'PGRST116') {
    return new Response(
      JSON.stringify({ error: 'Budget not found or access denied' }),
      { 
        status: 404,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    )
  }
  throw budgetError
}</code></pre>

                    <h3>Service Role Authentication</h3>
                    <p>For operations that need to bypass RLS (use sparingly):</p>
                    
                    <pre><code class="language-typescript">// Create service role client (bypasses RLS)
const supabaseAdmin = createClient(
  Deno.env.get('SUPABASE_URL') ?? '',
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '',
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
)</code></pre>

                    <div class="alert alert-warning">
                        <strong>Security Warning:</strong> Service role clients bypass Row Level Security. Only use when absolutely necessary and always validate user permissions manually.
                    </div>
                </section>

                <section id="validation">
                    <h2>‚úÖ Validation & Error Handling</h2>
                    
                    <h3>Request Body Validation</h3>
                    <pre><code class="language-typescript">// Parse and validate request body
const body = await req.json()

// Validate required fields
if (!body.transaction_type || !body.amount || !body.transaction_date) {
  return new Response(
    JSON.stringify({ 
      error: 'transaction_type, amount, and transaction_date are required' 
    }),
    { 
      status: 400,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    }
  )
}

// Validate data types and constraints
if (body.amount <= 0) {
  return new Response(
    JSON.stringify({ error: 'Transaction amount must be positive' }),
    { 
      status: 400,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    }
  )
}

// Validate decimal places
if (!Number.isInteger(body.amount * 100)) {
  return new Response(
    JSON.stringify({ error: 'Amount can have at most 2 decimal places' }),
    { 
      status: 400,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    }
  )
}</code></pre>

                    <h3>Business Logic Validation</h3>
                    <pre><code class="language-typescript">// Validate transaction type specific requirements
switch (body.transaction_type) {
  case 'income':
    if (!body.income_source_id || body.from_envelope_id || 
        body.to_envelope_id || body.payee_id) {
      return new Response(
        JSON.stringify({ 
          error: 'Income transactions require income_source_id and no envelope or payee references' 
        }),
        { 
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }
    
    // Validate income source exists and is active
    const { data: incomeSource, error: incomeSourceError } = await supabaseClient
      .from('income_sources')
      .select('id, is_active')
      .eq('id', body.income_source_id)
      .eq('budget_id', budgetId)
      .single()
    
    if (incomeSourceError || !incomeSource || !incomeSource.is_active) {
      return new Response(
        JSON.stringify({ error: 'Invalid or inactive income source' }),
        { 
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }
    break
    
  // Handle other transaction types...
}</code></pre>

                    <h3>Error Response Patterns</h3>
                    <pre><code class="language-typescript">// Standard error response helper
function errorResponse(message: string, status: number = 400) {
  return new Response(
    JSON.stringify({ error: message }),
    { 
      status,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    }
  )
}

// Usage
if (!body.required_field) {
  return errorResponse('required_field is required', 400)
}

// Handle database errors
try {
  const { data, error } = await supabaseClient.from('table').insert(data)
  if (error) throw error
} catch (error) {
  if (error.code === 'PGRST116') {
    return errorResponse('Record not found', 404)
  }
  throw error // Let global handler catch it
}</code></pre>
                </section>

                <section id="database-operations">
                    <h2>üóÉ Database Operations</h2>
                    
                    <h3>Complex Queries with Relationships</h3>
                    <pre><code class="language-typescript">// Get transaction with all related data
const { data: transaction, error } = await supabaseClient
  .from('transactions')
  .select(`
    *,
    from_envelope:envelopes!from_envelope_id(*),
    to_envelope:envelopes!to_envelope_id(*),
    payee:payees!payee_id(*),
    income_source:income_sources!income_source_id(*),
    category:categories!category_id(*)
  `)
  .eq('id', transactionId)
  .single()</code></pre>

                    <h3>Database Functions (RPC)</h3>
                    <pre><code class="language-typescript">// Call database function for complex calculations
const { data: dashboardData, error: dashboardError } = await supabaseClient
  .rpc('get_dashboard_summary', {
    p_budget_id: budgetId
  })

if (dashboardError) {
  throw dashboardError
}</code></pre>

                    <h3>Transactions and Atomic Operations</h3>
                    <pre><code class="language-typescript">// Use database transactions for atomic updates
const { data, error } = await supabaseClient.rpc('create_transaction_with_balance_update', {
  p_budget_id: budgetId,
  p_transaction_type: body.transaction_type,
  p_amount: body.amount,
  p_from_envelope_id: body.from_envelope_id,
  p_to_envelope_id: body.to_envelope_id
})

if (error) {
  throw error
}</code></pre>

                    <h3>Bulk Operations</h3>
                    <pre><code class="language-typescript">// Process multiple records efficiently
const { data: envelopes } = await supabaseClient
  .from('envelopes')
  .select('*')
  .in('id', envelopeIds)
  .eq('budget_id', budgetId)

// Validate all envelopes exist
if (envelopes.length !== envelopeIds.length) {
  return errorResponse('One or more envelopes not found')
}

// Perform bulk update
const updates = envelopes.map(envelope => ({
  id: envelope.id,
  is_active: false,
  updated_at: new Date().toISOString()
}))

const { error: updateError } = await supabaseClient
  .from('envelopes')
  .upsert(updates)</code></pre>
                </section>

                <section id="testing">
                    <h2>üß™ Testing</h2>
                    
                    <h3>Local Testing</h3>
                    <pre><code class="language-bash"># Test function locally
curl -X POST http://localhost:54321/functions/v1/transactions \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "transaction_type": "income",
    "amount": 1000.00,
    "transaction_date": "2025-01-31",
    "income_source_id": "uuid-here"
  }'</code></pre>

                    <h3>Unit Testing with Deno</h3>
                    <pre><code class="language-typescript">// test/transaction-validation.test.ts
import { assertEquals } from "https://deno.land/std@0.168.0/testing/asserts.ts"

Deno.test("should validate transaction amount", () => {
  const amount = 100.00
  const isValid = Number.isInteger(amount * 100)
  assertEquals(isValid, true)
})

Deno.test("should reject negative amounts", () => {
  const amount = -50.00
  assertEquals(amount > 0, false)
})</code></pre>

                    <h3>Integration Testing</h3>
                    <pre><code class="language-bash"># Run tests
deno test --allow-net --allow-env test/</code></pre>

                    <h3>Testing with Mock Data</h3>
                    <pre><code class="language-typescript">// Create test helper
export function createMockRequest(
  method: string, 
  path: string, 
  body?: any,
  headers: Record<string, string> = {}
): Request {
  return new Request(`http://localhost${path}`, {
    method,
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer mock-token',
      ...headers
    },
    body: body ? JSON.stringify(body) : undefined
  })
}

// Use in tests
const request = createMockRequest('POST', '/budgets/123/transactions', {
  transaction_type: 'income',
  amount: 1000.00
})</code></pre>
                </section>

                <section id="deployment">
                    <h2>üöÄ Deployment</h2>
                    
                    <h3>Deploy Single Function</h3>
                    <pre><code class="language-bash"># Deploy specific function
supabase functions deploy transactions

# Deploy with custom JWT secret
supabase functions deploy transactions --jwt-secret YOUR_JWT_SECRET</code></pre>

                    <h3>Deploy All Functions</h3>
                    <pre><code class="language-bash"># Deploy all functions
supabase functions deploy</code></pre>

                    <h3>Environment Variables in Production</h3>
                    <pre><code class="language-bash"># Set environment variables
supabase secrets set CUSTOM_SECRET=your-secret-value
supabase secrets set API_KEY=your-api-key

# List secrets
supabase secrets list</code></pre>

                    <h3>Function URLs</h3>
                    <p>Deployed functions are available at:</p>
                    <pre><code class="language-bash"># Production URL pattern
https://YOUR_PROJECT_REF.supabase.co/functions/v1/FUNCTION_NAME

# Example
https://abcdefgh.supabase.co/functions/v1/transactions</code></pre>
                </section>

                <section id="monitoring">
                    <h2>üìä Monitoring & Debugging</h2>
                    
                    <h3>Logging</h3>
                    <pre><code class="language-typescript">// Structured logging
console.log('Transaction created', {
  transactionId: transaction.id,
  budgetId: budgetId,
  amount: body.amount,
  type: body.transaction_type,
  userId: user.id
})

// Error logging
console.error('Transaction validation failed', {
  error: error.message,
  budgetId: budgetId,
  requestBody: body
})</code></pre>

                    <h3>View Logs</h3>
                    <pre><code class="language-bash"># View function logs
supabase functions logs transactions

# View logs with follow
supabase functions logs transactions --follow

# View logs with level filter
supabase functions logs transactions --level error</code></pre>

                    <h3>Performance Monitoring</h3>
                    <pre><code class="language-typescript">// Add timing to critical operations
const startTime = Date.now()

// ... operation ...

const duration = Date.now() - startTime
console.log('Operation completed', {
  operation: 'create_transaction',
  duration_ms: duration,
  success: true
})</code></pre>

                    <h3>Error Tracking</h3>
                    <pre><code class="language-typescript">// Comprehensive error logging
try {
  // ... operation ...
} catch (error) {
  console.error('Function error', {
    error: error.message,
    stack: error.stack,
    function: 'transactions',
    endpoint: req.url,
    method: req.method,
    userId: user?.id,
    timestamp: new Date().toISOString()
  })
  
  throw error
}</code></pre>
                </section>

                <section id="best-practices">
                    <h2>‚≠ê Best Practices</h2>
                    
                    <h3>1. Security</h3>
                    <ul>
                        <li><strong>Always authenticate:</strong> Verify JWT tokens and user permissions</li>
                        <li><strong>Validate all inputs:</strong> Never trust client data</li>
                        <li><strong>Use RLS:</strong> Rely on Row Level Security policies when possible</li>
                        <li><strong>Minimize service role usage:</strong> Only bypass RLS when absolutely necessary</li>
                        <li><strong>Sanitize outputs:</strong> Don't expose sensitive information in errors</li>
                    </ul>

                    <h3>2. Performance</h3>
                    <ul>
                        <li><strong>Minimize database calls:</strong> Batch operations when possible</li>
                        <li><strong>Use database functions:</strong> Push complex logic to SQL for better performance</li>
                        <li><strong>Cache expensive operations:</strong> Consider caching for repeated calculations</li>
                        <li><strong>Optimize queries:</strong> Use indexes and efficient query patterns</li>
                        <li><strong>Handle timeouts:</strong> Set reasonable timeouts for external calls</li>
                    </ul>

                    <h3>3. Error Handling</h3>
                    <ul>
                        <li><strong>Consistent error format:</strong> Use standard error response structure</li>
                        <li><strong>Meaningful error messages:</strong> Provide actionable feedback to clients</li>
                        <li><strong>Log errors properly:</strong> Include context for debugging</li>
                        <li><strong>Handle database errors:</strong> Map database error codes to HTTP status codes</li>
                        <li><strong>Fail fast:</strong> Validate inputs early to avoid partial operations</li>
                    </ul>

                    <h3>4. Code Organization</h3>
                    <ul>
                        <li><strong>Single responsibility:</strong> Each function should have a clear purpose</li>
                        <li><strong>Reusable utilities:</strong> Share common logic in <code>_shared</code> directory</li>
                        <li><strong>Consistent patterns:</strong> Follow established architectural patterns</li>
                        <li><strong>Type safety:</strong> Use TypeScript interfaces for better code quality</li>
                        <li><strong>Documentation:</strong> Comment complex business logic</li>
                    </ul>

                    <h3>5. Testing</h3>
                    <ul>
                        <li><strong>Test locally first:</strong> Use local development environment</li>
                        <li><strong>Unit test validation:</strong> Test business logic separately</li>
                        <li><strong>Integration testing:</strong> Test complete workflows</li>
                        <li><strong>Mock external dependencies:</strong> Isolate function logic from external services</li>
                        <li><strong>Test error scenarios:</strong> Ensure proper error handling</li>
                    </ul>

                    <div class="alert alert-success">
                        <strong>üí° Pro Tip:</strong> Start with PostgREST for simple operations, then migrate to Edge Functions when you need complex business logic. This approach keeps your architecture clean and performant.
                    </div>
                </section>

                <div class="alert alert-info">
                    <strong>üìñ More Information:</strong> For detailed API documentation and PostgREST alternatives, see the <a href="/docs/api">full API documentation</a> and <a href="/docs/postgrest-integration">PostgREST Integration Guide</a>.
                </div>
            </div>
        </div>
    </div>

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>